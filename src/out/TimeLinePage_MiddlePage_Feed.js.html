<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: TimeLinePage/MiddlePage/Feed.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: TimeLinePage/MiddlePage/Feed.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { useRef, useCallback } from "react";
import classes from "./Feed.module.css";
import FeedTweetBox from "./UpperTweetBox/FeedTweetBox";
import FeedTweet from "./FeedTweet";
// import defaultMaleProfile from "../../../Assets/defaultMaleProfile.jpg";
import axios from "axios";
import ReactLoading from "react-loading";
import instance from "../../axios";
// import { ContactlessOutlined } from "@material-ui/icons";
// import { useHistory } from "react-router-dom";
import { useState } from "react";
import { browserName, browserVersion } from "react-device-detect";
import DefaultProfilePic from "../../../Assets/DefaultProfilePic.jpg";
// import { data } from "jquery";

/**
 * This is the Feed component which is used to get the tweets from the backend
 * using the /home request and then it will render the tweets in the feed.
 */
export default function Feed(props) {
  const [users, setUsers] = React.useState([]);
  const [tweets, setTweets] = React.useState([]);
  const [followingList, setFollowingList] = React.useState([]);
  const [isLoading, setLoading] = React.useState(true);
  const [pageNumber, setPageNumber] = React.useState(1);
  const [hasMore, setHasMore] = React.useState(true);
  const [followingSet, setFollowingSet] = React.useState(new Set());
  const observer = useRef();
  let isMock = localStorage.getItem("isMock") === "true";

  const lastTweetElementRef = useCallback(
    (node) => {
      if (isLoading) return;
      if (observer.current) observer.current.disconnect();
      observer.current = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting &amp;&amp; hasMore) {
          setPageNumber((prevPageNumber) => prevPageNumber + 1);
        }
      });
      if (node) observer.current.observe(node);
    },
    [isLoading, hasMore]
  );
  const [calling, setCalling] = useState(0);
  // React.useEffect(() => {
  //   // addTweets;
  //   if (calling !== 0) {
  //     addTweet(props.currentTweet);
  //   }
  //   setCalling(1);
  // }, [props.updateTweets]);

  React.useEffect(() => subscribeNotifications(), []);
  React.useEffect(() => getTweets(), [pageNumber]);
  const getTweets = async () => {
    setLoading(true);
    let response;
    let newTweets;
    let tryAgain = true;
    if (!isMock) {
      if (!props.testUrl)
        response = await instance.get(`/home/${pageNumber}/5`);
      else response = await axios.get(props.testUrl);
      newTweets = response.data.tweets;
    } else {
      await fetch(`http://localhost:3000/home?_page=${pageNumber}&amp;_limit=5`)
        .then((res) => res.json())
        .then((data) => {
          newTweets = data;
        });
    }
    newTweets.forEach((APItweet) => {
      let tweet = APItweet
        ? {
            name: APItweet.user.name,
            profilePic: APItweet.user.profile_image_url
              ? APItweet.user.profile_image_url
              : DefaultProfilePic,
            userName: APItweet.user.username,
            isVerified: APItweet.user.isVerified,
            bio: APItweet.user.bio,
            isFollowing: APItweet.user.is_followed,
            followers: APItweet.user.followers_count,
            following: APItweet.user.following_count,
            text: APItweet.content,
            tweetId: APItweet.id,
            date: APItweet.created_at,
            replies: APItweet.replies,
            repliesCount: APItweet.replies_count,
            likes: APItweet.likes_count,
            retweets: APItweet.retweets_count,
            quotes: APItweet.quotes_count,
            isLiked: APItweet.is_liked,
            isRetweeted: APItweet.is_retweeted,
            isTweetReply: APItweet.is_reply,
            media: APItweet.media,
            gif: APItweet.gif ? APItweet.gif : "",
          }
        : null;
      setFollowingSet((prevSet) => {
        let newSet = new Set(prevSet);
        newSet.add(tweet.userName);
        return newSet;
      });
      //console.log(tweet);
      setTweets((prevTweets) => {
        return [...prevTweets, tweet];
      });
    });
    setHasMore(newTweets.length === 5);
    setLoading(false);
  };

  const subscribeNotifications = async () => {
    const vapidKeys = await instance.get("/vapid-key");
    const publicKey = vapidKeys.data.publicKey;
    const privateKey = vapidKeys.data.privateKey;
    navigator.serviceWorker.ready.then((sw) => {
      const options = {
        userVisibleOnly: true,
        applicationServerKey: publicKey,
      };
      sw.pushManager
        .subscribe(options)
        .then(async (push) => {
          console.log(push);
          await instance.post("/add-subscription", {
            subscription: push,
            privateKey: privateKey,
            publicKey: publicKey,
          });
        })
        .catch((err) => {
          console.log(err);
        });
    });
  };
  function addTweet(tweet) {
    //   setTweets((prevTweets) => {
    //     let tweet_to_add = {
    //       name: tweet.user.name,
    //       profilePic: tweet.user.profile_image_url,
    //       userName: tweet.user.username,
    //       isVerified: tweet.user.isVerified,
    //       bio: tweet.user.bio,
    //       followers: tweet.user.followers_count,
    //       following: tweet.user.following_count,
    //       text: tweet.content,
    //       tweetId: tweet.id,
    //       date: tweet.created_at,
    //       replies: tweet.replies,
    //       likes: tweet.likes_count,
    //       retweets: tweet.retweets_count,
    //       quotes: tweet.quotes_count,
    //       isLiked: tweet.is_liked,
    //       isRetweeted: tweet.is_retweeted,
    //       isReply: tweet.is_reply,
    //     };
    //     return [tweet_to_add, ...prevTweets];
    //   });
    return;
  }
  const [postingTweet, setPostingTweet] = useState(0);
  function changePostingTweet() {
    setPostingTweet((prev) => {
      return !prev;
    });
  }

  return (
    &lt;div className={classes.feed}>
      &lt;h2 className={classes.feedHeader}>Home&lt;/h2>
      &lt;FeedTweetBox
        onAddTweet={addTweet}
        changePostingTweet={changePostingTweet}
      />
      {postingTweet ? &lt;p>tweeting...&lt;/p> : &lt;React.Fragment>&lt;/React.Fragment>}
      {tweets.map((tweet, index) => {
        if (index === tweets.length - 1) {
          return (
            &lt;div
              data-testid={`tweet-${index}`}
              ref={lastTweetElementRef}
              key={index}
            >
              &lt;FeedTweet
                {...tweet}
                showAction={true}
                key={index}
                setPhotosActive={props.setPhotosActive}
                setIncrement={props.setIncrement}
                followingSet={followingSet}
                setFollowingSet={setFollowingSet}
              />
            &lt;/div>
          );
        } else {
          return (
            &lt;FeedTweet
              data-testid={`tweet-${index}`}
              {...tweet}
              key={index}
              showAction={true}
              setPhotosActive={props.setPhotosActive}
              setIncrement={props.setIncrement}
              followingSet={followingSet}
              setFollowingSet={setFollowingSet}
            />
          );
        }
      })}
      {isLoading &amp;&amp; (
        &lt;ReactLoading
          type={"spin"}
          color={"#1DA1F2"}
          height={"4%"}
          width={"4%"}
          className={`${classes.loadingIcon}`}
        />
      )}
    &lt;/div>
  );
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#AccountButton">AccountButton</a></li><li><a href="global.html#DeleteModal">DeleteModal</a></li><li><a href="global.html#ImageGrid">ImageGrid</a></li><li><a href="global.html#LeftSideBar">LeftSideBar</a></li><li><a href="global.html#MiniProfile">MiniProfile</a></li><li><a href="global.html#MoreButton">MoreButton</a></li><li><a href="global.html#PhotosPage">PhotosPage</a></li><li><a href="global.html#rotateSize">rotateSize</a></li><li><a href="global.html#TweetAndReplies">TweetAndReplies</a></li><li><a href="global.html#TweetAtrribute">TweetAtrribute</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Tue May 24 2022 20:05:32 GMT+0200 (Eastern European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
